#!/sbin/openrc-run
# Copyright (c) 2007-2015 The OpenRC Authors.
# See the Authors file at the top-level directory of this distribution and
# https://github.com/OpenRC/openrc/blob/master/AUTHORS
#
# This file is part of OpenRC. It is subject to the license terms in
# the LICENSE file found in the top-level directory of this
# distribution and at https://github.com/OpenRC/openrc/blob/master/LICENSE
# This file may not be copied, modified, propagated, or distributed
# except according to the terms contained in the LICENSE file.

command=%%PREFIX%%/sbin/wpa_supplicant
: ${wpa_supplicant_conf:=/etc/wpa_supplicant.conf}
wpa_supplicant_if=${wpa_supplicant_if:+-i}$wpa_supplicant_if
command_args="$wpa_supplicant_args -B -c$wpa_supplicant_conf $wpa_supplicant_if"
name="WPA Supplicant Daemon"

depend()
{
        provide wpa_supplicant
        need localmount net
        after bootmisc modules devd network
	before dhcpcd
	keyword -shutdown
}

find_wireless()
{
	local iface=

	for iface in $(sysctl -b net.wlan.devices 2>/dev/null); do
		echo "${iface##*/}"
	done
}

append_wireless()
{
	local iface= i=

	iface=$(find_wireless)
	if [ -n "$iface" ]; then
	wnum="0"
		for i in $iface; do
			command_args="$command_args -iwlan${wnum}"
			wnum=`expr $wnum + 1`
		done
	else
                einfo "Could not find a wireless interface"
                mark_service_inactive
                return 1
	fi
}

start_pre()
{
	case " $command_args" in
	*" -i"*) ;;
	*) append_wireless || exit 1 ;;
	esac

        if [ ! -e "/etc/wpa_supplicant.conf" ] ; then
		echo "ctrl_interface=/var/run/wpa_supplicant" > /etc/wpa_supplicant.conf
		chmod 600 /etc/wpa_supplicant.conf
        fi

}
